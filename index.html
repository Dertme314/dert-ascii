<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to ASCII Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .ascii-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .ascii-scroll::-webkit-scrollbar-track { background: transparent; }
        .ascii-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        .dropzone:hover { border-color: #6366f1; background-color: #f9fafb; }
        .dark .dropzone:hover { border-color: #818cf8; background-color: #1f2937; }

        canvas { image-rendering: pixelated; }
        
        /* Smooth transitions */
        .btn-transition { transition: all 0.2s ease; }
        .btn-transition:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="w-full bg-white/80 backdrop-blur-md dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-indigo-500/30">A</div>
                <h1 class="text-lg font-semibold tracking-tight">ASCII<span class="text-gray-500 dark:text-gray-400">Motion</span></h1>
            </div>
            <a href="https://github.com/antimatter15/whammy" target="_blank" class="text-xs text-gray-400 hover:text-indigo-500 transition-colors">Powered by Whammy.js</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- LEFT COLUMN: Editor -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- 1. Upload Section -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-1 overflow-hidden">
                <div class="p-5">
                    <h2 class="text-sm uppercase tracking-wider text-gray-500 font-semibold mb-3">1. Source Video</h2>
                    
                    <div class="relative dropzone border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 text-center transition-all cursor-pointer group">
                        <input type="file" id="videoFile" accept="video/mp4, video/webm, video/mov" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="flex flex-col items-center pointer-events-none group-hover:scale-105 transition-transform duration-300">
                            <div class="w-12 h-12 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-full flex items-center justify-center mb-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            </div>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Click or Drop Video</p>
                            <p class="text-xs text-gray-500 mt-1">MP4, WebM (Max 30s rec.)</p>
                        </div>
                    </div>

                    <!-- Selected File Info -->
                    <div id="fileInfo" class="mt-4 hidden animate-fade-in">
                        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-700">
                            <div class="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="overflow-hidden">
                                <p id="fileName" class="text-sm font-medium truncate text-gray-800 dark:text-gray-200">video.mp4</p>
                                <p id="fileMeta" class="text-xs text-gray-500">Calculating...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Settings Section -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                <h2 class="text-sm uppercase tracking-wider text-gray-500 font-semibold mb-4">2. Adjust Style</h2>
                
                <div class="space-y-6">
                    <!-- Resolution -->
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <label class="font-medium text-gray-700 dark:text-gray-300">Quality / Size</label>
                            <span id="widthVal" class="text-indigo-600 font-mono">120 chars</span>
                        </div>
                        <input type="range" id="asciiWidth" min="40" max="300" value="120" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-indigo-600">
                    </div>

                    <!-- Contrast -->
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <label class="font-medium text-gray-700 dark:text-gray-300">Contrast</label>
                            <span id="contrastVal" class="text-indigo-600 font-mono">1.0</span>
                        </div>
                        <input type="range" id="contrast" min="0.5" max="2.5" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-indigo-600">
                    </div>

                    <!-- Color Mode -->
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg cursor-pointer" onclick="document.getElementById('color').click()">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Preserve Colors</span>
                        <div class="relative inline-flex items-center cursor-pointer pointer-events-none">
                            <input type="checkbox" id="color" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </div>
                    </div>
                    
                     <!-- Charset (Advanced Toggle) -->
                     <div class="pt-2">
                        <details class="text-xs text-gray-500">
                            <summary class="cursor-pointer hover:text-indigo-600 select-none">Advanced: Character Set</summary>
                            <input type="text" id="chars" value="@%#*+=-:. " class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded text-sm font-mono tracking-widest text-center">
                        </details>
                    </div>
                </div>
            </section>

            <!-- 3. Actions -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                <!-- Progress -->
                <div id="progressContainer" class="hidden mb-4">
                    <div class="flex justify-between text-xs mb-1 font-medium">
                        <span id="progressLabel" class="text-indigo-600">Encoding frames...</span>
                        <span id="progressText" class="text-gray-900 dark:text-white">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2 dark:bg-gray-700 overflow-hidden">
                        <div id="progressBar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Convert Button -->
                <button id="convertBtn" disabled class="btn-transition w-full py-3.5 px-4 bg-gray-900 dark:bg-white dark:text-gray-900 text-white font-semibold rounded-xl shadow-lg shadow-gray-200 dark:shadow-none disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2">
                    <span>Select Video First</span>
                </button>

                <!-- Download Button -->
                <a id="downloadLink" href="#" class="hidden mt-3 btn-transition w-full py-3.5 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl shadow-lg shadow-green-500/30 text-center flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Download ASCII Video</span>
                </a>
            </section>

        </div>

        <!-- RIGHT COLUMN: Preview -->
        <div class="lg:col-span-8 h-full min-h-[500px]">
            <div class="bg-gray-100 dark:bg-black rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden h-full flex flex-col relative shadow-inner">
                
                <!-- Preview Header -->
                <div class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none z-10">
                    <div class="bg-black/50 backdrop-blur-md text-white text-xs px-3 py-1.5 rounded-full font-medium border border-white/10">
                        Live Preview
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="flex-grow flex items-center justify-center overflow-auto ascii-scroll p-8" id="canvasContainer">
                    <div id="placeholder" class="text-center text-gray-400 dark:text-gray-600">
                        <div class="w-20 h-20 mx-auto mb-4 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl flex items-center justify-center">
                            <span class="text-2xl">ðŸ“º</span>
                        </div>
                        <p class="text-sm font-medium">Video preview will appear here</p>
                    </div>
                    <canvas id="asciiCanvas" class="hidden shadow-2xl"></canvas>
                </div>

            </div>
        </div>

    </main>

    <!-- Hidden Processing Elements -->
    <video id="video" class="hidden" preload="auto" playsinline muted></video>
    <canvas id="videoCanvas" class="hidden"></canvas>

    <!-- Whammy JS -->
    <script src="https://cdn.jsdelivr.net/gh/antimatter15/whammy/whammy.js"></script>

    <script>
        // --- 1. CONFIGURATION & DOM ---
        const els = {
            fileInput: document.getElementById('videoFile'),
            video: document.getElementById('video'),
            videoCanvas: document.getElementById('videoCanvas'),
            asciiCanvas: document.getElementById('asciiCanvas'),
            convertBtn: document.getElementById('convertBtn'),
            downloadLink: document.getElementById('downloadLink'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            fileMeta: document.getElementById('fileMeta'),
            placeholder: document.getElementById('placeholder'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            inputs: {
                contrast: document.getElementById('contrast'),
                width: document.getElementById('asciiWidth'),
                chars: document.getElementById('chars'),
                color: document.getElementById('color')
            }
        };

        const ctx = {
            // CRITICAL FIX: Ensure willReadFrequently is true for fast read operations
            video: els.videoCanvas.getContext('2d', { willReadFrequently: true }),
            ascii: els.asciiCanvas.getContext('2d')
        };

        // UI Updates
        els.inputs.contrast.addEventListener('input', e => document.getElementById('contrastVal').innerText = e.target.value);
        els.inputs.width.addEventListener('input', e => document.getElementById('widthVal').innerText = e.target.value + ' chars');
        
        // Update preview on setting change (debounce for performance)
        let debounceTimer;
        const updatePreview = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (els.video.readyState >= 2) drawAsciiFrame(parseInt(els.inputs.width.value));
            }, 50);
        };
        Object.values(els.inputs).forEach(input => input.addEventListener('input', updatePreview));


        // --- 2. FILE LOADING ---
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Reset UI
            els.downloadLink.classList.add('hidden');
            els.progressContainer.classList.add('hidden');
            els.convertBtn.disabled = true;
            els.convertBtn.innerHTML = `<span>Loading Metadata...</span>`;

            els.fileInfo.classList.remove('hidden');
            els.fileName.innerText = file.name;
            els.fileMeta.innerText = "Processing...";

            const url = URL.createObjectURL(file);
            els.video.src = url;
            els.video.load();
        });

        els.video.addEventListener('loadeddata', () => {
            els.fileMeta.innerText = `${els.video.duration.toFixed(1)}s â€¢ ${els.video.videoWidth}x${els.video.videoHeight}`;
            
            els.convertBtn.disabled = false;
            els.convertBtn.innerHTML = `<span>Convert to ASCII Video</span>`;
            els.convertBtn.className = "btn-transition w-full py-3.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 cursor-pointer";

            els.placeholder.classList.add('hidden');
            els.asciiCanvas.classList.remove('hidden');
            
            drawAsciiFrame(parseInt(els.inputs.width.value));
        });


        // --- 3. CORE LOGIC ---
        function mapChar(val, chars) {
            return chars[Math.floor((val / 255) * (chars.length - 1))];
        }
        
        // Simple contrast adjustment
        function applyContrast(value, contrast) {
            const factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255));
            let adjusted = factor * (value - 128) + 128;
            return Math.max(0, Math.min(255, adjusted));
        }

        function drawAsciiFrame(width) {
            const w = els.video.videoWidth;
            const h = els.video.videoHeight;
            if (!w || !h) return;

            const ratio = h / w;
            const height = Math.floor(width * ratio);

            // Resize Internal Canvas
            els.videoCanvas.width = width;
            els.videoCanvas.height = height;

            // Calculate Font Size
            const fontSize = 12;
            const charWidth = fontSize * 0.6;
            
            // Resize Output Canvas
            els.asciiCanvas.width = Math.floor(width * charWidth);
            els.asciiCanvas.height = Math.floor(height * fontSize);

            // Fill Background
            ctx.ascii.fillStyle = "#000";
            ctx.ascii.fillRect(0, 0, els.asciiCanvas.width, els.asciiCanvas.height);
            ctx.ascii.font = `${fontSize}px monospace`;
            ctx.ascii.textBaseline = 'top';

            // Draw Source
            ctx.video.drawImage(els.video, 0, 0, width, height);
            const frame = ctx.video.getImageData(0, 0, width, height);
            const data = frame.data;

            // ASCII Conversion
            const chars = els.inputs.chars.value;
            const contrast = parseFloat(els.inputs.contrast.value);
            const color = els.inputs.color.checked;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    
                    // Apply contrast to color channels
                    let r = applyContrast(data[i], contrast);
                    let g = applyContrast(data[i+1], contrast);
                    let b = applyContrast(data[i+2], contrast);
                    
                    // Grayscale for character selection
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    const char = mapChar(gray, chars);

                    ctx.ascii.fillStyle = color ? `rgb(${r},${g},${b})` : "#fff";
                    ctx.ascii.fillText(char, x * charWidth, y * fontSize);
                }
            }
        }


        // --- 4. CONVERSION PROCESS ---
        const seekTo = (time) => new Promise(resolve => {
            const handler = () => {
                els.video.removeEventListener('seeked', handler);
                resolve();
            };
            els.video.addEventListener('seeked', handler);
            els.video.currentTime = time;
        });

        els.convertBtn.addEventListener('click', async () => {
            els.convertBtn.disabled = true;
            els.progressContainer.classList.remove('hidden');
            els.downloadLink.classList.add('hidden');
            
            const fps = 15;
            const whammyVideo = new Whammy.Video(fps, 0.8); // Quality set in constructor
            
            const duration = els.video.duration;
            const interval = 1 / fps;
            let currentTime = 0;

            try {
                while (currentTime < duration) {
                    await seekTo(currentTime);
                    drawAsciiFrame(parseInt(els.inputs.width.value));
                    
                    // CRITICAL FIX: Clone canvas content to avoid reference issues AND 
                    // force aggressive PNG compression (quality 0.5) to reduce memory load
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = els.asciiCanvas.width;
                    tempCanvas.height = els.asciiCanvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(els.asciiCanvas, 0, 0);
                    
                    // Whammy.js add(canvas, quality) -> quality must be low for long videos
                    whammyVideo.add(tempCanvas, 0.5); 

                    currentTime += interval;
                    const pct = Math.min(99, Math.round((currentTime / duration) * 100));
                    els.progressBar.style.width = `${pct}%`;
                    els.progressText.innerText = `${pct}%`;
                    els.convertBtn.innerHTML = `<span>Encoding Frames... ${pct}%</span>`;


                    // Allow UI to breathe
                    await new Promise(r => setTimeout(r, 0));
                }

                els.progressText.innerText = "Finalizing...";
                els.convertBtn.innerHTML = `<span>Compiling Video...</span>`;

                const output = whammyVideo.compile();
                
                if (!output || output.size === 0) {
                    throw new Error("Video compilation failed. Try a lower 'Quality / Size' setting or a shorter video.");
                }
                
                const url = URL.createObjectURL(output);
                
                els.progressBar.style.width = `100%`;
                els.downloadLink.href = url;
                els.downloadLink.download = `ascii_${els.fileName.innerText.split('.')[0]}.webm`;
                els.downloadLink.classList.remove('hidden');
                
                els.convertBtn.innerHTML = `<span>Conversion Complete!</span>`;
                els.convertBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                els.convertBtn.classList.add('bg-gray-800', 'cursor-not-allowed');
                els.convertBtn.disabled = true;

            } catch (err) {
                console.error(err);
                els.progressText.innerText = `Error`;
                alert("Conversion failed. Try a shorter video or lower the 'Quality / Size'. Error: " + err.message);
                
                els.convertBtn.disabled = false;
                els.convertBtn.innerHTML = `<span>Try Again</span>`;
                els.convertBtn.classList.remove('bg-gray-800', 'cursor-not-allowed');
                els.convertBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        });

    </script>
</body>
</html>
